{% extends "base.html" %}
{% block title %}Editar Día{% endblock %}

{% block content %}
<h2 class="mb-4">Editar <span class="text-primary">{{ fecha }}</span></h2>

<!-- Estado actual -->
<div class="mb-4">
  {% if pedido[0] or pedido[1] %}
    <span class="badge bg-secondary me-2">Pedido:
      {% if pedido[0] and pedido[1] %}
        Almuerzo y Cena
      {% elif pedido[0] %}
        Almuerzo
      {% elif pedido[1] %}
        Cena
      {% else %}
        Ninguno
      {% endif %}
    </span>
  {% else %}
    <span class="badge bg-light text-muted me-2">Sin pedido</span>
  {% endif %}
  {% if feriado %}
    <span class="badge bg-info text-white ms-2">Feriado</span>
  {% endif %}
  {% if entrega[0] or entrega[1] %}
    <span class="badge bg-success">Entregado:
      {% if entrega[0] and entrega[1] %}
        Almuerzo y Cena
      {% elif entrega[0] %}
        Almuerzo
      {% elif entrega[1] %}
        Cena
      {% else %}
        Ninguno
      {% endif %}
    </span>
  {% elif (pedido[0] or pedido[1]) and not feriado %}
    <span class="badge bg-warning text-dark">Entrega pendiente</span>
  {% endif %}
</div>

<form method="POST">
  <input type="hidden" name="fecha" value="{{ fecha }}">
  <div class="row g-4">
    <!-- Estado del día -->
    <div class="col-12">
      <div class="card shadow-sm border-info mb-4">
        <div class="card-header bg-info text-white">Estado del día</div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="feriado" id="feriado" {% if feriado %}checked{% endif %}>
            <label class="form-check-label fw-bold text-info" for="feriado">Feriado</label>
          </div>
        </div>
      </div>
    </div>

    {% if not feriado %}
    <!-- Pedido -->
    <div class="col-md-6">
      <div class="card shadow-sm border-secondary">
        <div class="card-header bg-secondary text-white">Pedido</div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="almuerzo" id="almuerzo" {% if pedido[0] %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="almuerzo">Almuerzo</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" name="cena" id="cena" {% if pedido[1] %}checked{% endif %}>
            <label class="form-check-label fw-bold" for="cena">Cena</label>
          </div>
          <div class="mb-3">
            <label for="obs_pedido" class="form-label">Observación del pedido</label>
            <textarea class="form-control" name="obs_pedido" id="obs_pedido" rows="2">{{ obs_pedido }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Entrega -->
    <div class="col-md-6">
      <div class="card shadow-sm border-success">
        <div class="card-header bg-success text-white">Entrega</div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="entregado_almuerzo" id="entregado_almuerzo" {% if entrega[0] %}checked{% endif %}>
            <label class="form-check-label fw-bold text-success" for="entregado_almuerzo">Almuerzo entregado</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" name="entregado_cena" id="entregado_cena" {% if entrega[1] %}checked{% endif %}>
            <label class="form-check-label fw-bold text-success" for="entregado_cena">Cena entregada</label>
          </div>
          <div class="mb-3">
            <label for="obs_entrega" class="form-label">Observación de entrega</label>
            <textarea class="form-control" name="obs_entrega" id="obs_entrega" rows="2">{{ entrega[2] }}</textarea>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="mt-4 d-flex justify-content-between">
    <a href="/semana" class="btn btn-outline-secondary">← Volver a semana</a>
    <button type="submit" class="btn btn-primary" id="guardarBtn" style="display:none;">Guardar</button>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.querySelector('form');
  const guardarBtn = document.getElementById('guardarBtn');

  // Capturar estado original
  const originalState = {};
  form.querySelectorAll('input, textarea').forEach(el => {
    if (el.type === 'checkbox') {
      originalState[el.name] = el.checked;
    } else {
      originalState[el.name] = el.value;
    }
  });

  function detectChanges() {
    let cambiado = false;
    form.querySelectorAll('input, textarea').forEach(el => {
      const original = originalState[el.name];
      const actual = el.type === 'checkbox' ? el.checked : el.value;
      if (original !== actual) {
        cambiado = true;
      }
    });
    guardarBtn.style.display = cambiado ? 'inline-block' : 'none';
  }

  form.addEventListener('input', detectChanges);
  form.addEventListener('change', detectChanges);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const feriadoSwitch = document.getElementById('feriado');
  const camposBloqueables = [
    'almuerzo', 'cena',
    'entregado_almuerzo', 'entregado_cena',
    'obs_pedido', 'obs_entrega'
  ];

  function actualizarBloqueo() {
    const bloquear = feriadoSwitch.checked;
    camposBloqueables.forEach(id => {
      const campo = document.getElementById(id);
      if (campo) {
        campo.disabled = bloquear;
      }
    });
  }

  feriadoSwitch.addEventListener('change', actualizarBloqueo);
  actualizarBloqueo(); // aplicar al cargar
});
</script>
{% endblock %}
